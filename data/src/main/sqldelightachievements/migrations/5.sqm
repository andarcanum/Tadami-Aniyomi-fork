-- Migration v4 to v5: Add tier support, refactor activity_log, add user_profile

-- 1. Add tier columns to achievement_progress
ALTER TABLE achievement_progress ADD COLUMN current_tier INTEGER NOT NULL DEFAULT 0;
ALTER TABLE achievement_progress ADD COLUMN max_tier INTEGER NOT NULL DEFAULT 0;
ALTER TABLE achievement_progress ADD COLUMN tier_progress INTEGER NOT NULL DEFAULT 0;
ALTER TABLE achievement_progress ADD COLUMN tier_max_progress INTEGER NOT NULL DEFAULT 100;

-- 2. Migrate achievement_activity_log to new activity_log table
CREATE TABLE IF NOT EXISTS activity_log (
    date TEXT NOT NULL PRIMARY KEY,
    level INTEGER NOT NULL DEFAULT 0,
    type INTEGER NOT NULL DEFAULT 0,
    chapters_read INTEGER NOT NULL DEFAULT 0,
    episodes_watched INTEGER NOT NULL DEFAULT 0,
    app_opens INTEGER NOT NULL DEFAULT 0,
    achievements_unlocked INTEGER NOT NULL DEFAULT 0,
    duration_ms INTEGER NOT NULL DEFAULT 0,
    last_updated INTEGER NOT NULL
);

-- Migrate existing data from old achievement_activity_log table
INSERT OR IGNORE INTO activity_log (date, level, type, chapters_read, episodes_watched, last_updated)
SELECT
    date(date/1000, 'unixepoch') as date,
    CASE
        WHEN chapter_count >= 20 OR episode_count >= 10 THEN 4
        WHEN chapter_count >= 10 OR episode_count >= 5 THEN 3
        WHEN chapter_count >= 5 OR episode_count >= 2 THEN 2
        WHEN chapter_count > 0 OR episode_count > 0 THEN 1
        ELSE 0
    END as level,
    CASE WHEN episode_count > chapter_count THEN 2 ELSE 1 END as type,
    chapter_count,
    episode_count,
    last_updated
FROM achievement_activity_log;

-- Drop old table
DROP TABLE IF EXISTS achievement_activity_log;

-- Create indexes
CREATE INDEX IF NOT EXISTS activity_log_date_idx ON activity_log(date);
CREATE INDEX IF NOT EXISTS activity_log_level_idx ON activity_log(level);

-- 3. Create user_profile table
CREATE TABLE IF NOT EXISTS user_profile (
    user_id TEXT NOT NULL PRIMARY KEY DEFAULT 'default',
    username TEXT,
    level INTEGER NOT NULL DEFAULT 1,
    current_xp INTEGER NOT NULL DEFAULT 0,
    xp_to_next_level INTEGER NOT NULL DEFAULT 100,
    total_xp INTEGER NOT NULL DEFAULT 0,
    titles TEXT NOT NULL DEFAULT '[]',
    badges TEXT NOT NULL DEFAULT '[]',
    unlocked_themes TEXT NOT NULL DEFAULT '[]',
    achievements_unlocked INTEGER NOT NULL DEFAULT 0,
    total_achievements INTEGER NOT NULL DEFAULT 0,
    join_date INTEGER NOT NULL DEFAULT 0,
    last_updated INTEGER NOT NULL DEFAULT 0
);

-- Migrate data from old user_stats if exists
INSERT OR IGNORE INTO user_profile (user_id, level, total_xp, achievements_unlocked, join_date, last_updated)
SELECT
    'default',
    level,
    total_points,
    achievements_unlocked,
    strftime('%s', 'now') * 1000,
    strftime('%s', 'now') * 1000
FROM user_stats
WHERE id = 1;

-- Drop old table
DROP TABLE IF EXISTS user_stats;
